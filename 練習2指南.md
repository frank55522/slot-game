# 練習2 第一題實作指南

## 題目描述
調整feature game結算流程：當free games或dragon bonus games結束時，如果總贏分低於Big Win門檻，則跳過結算面板直接返回BaseGame。

## 1. 實作前的思路構築

### 1.1 問題分析
- **核心需求**：條件性跳過結算面板顯示
- **觸發條件**：總贏分 < Big Win門檻
- **影響範圍**：Free Game結算、Dragon Bonus結算
- **預期行為**：低於門檻時直接回到BaseGame，達到門檻時正常顯示結算面板

### 1.2 技術思考點
1. 需要找到Big Win門檻的定義位置
2. 需要找到結算面板顯示的控制邏輯
3. 需要了解PureMVC的Command模式
4. 需要理解遊戲狀態流轉機制

## 2. 專案架構理解

### 2.1 需要了解的專案核心部分

#### PureMVC架構模式
- **Command**：處理業務邏輯的指令
- **Proxy**：數據管理代理
- **Mediator**：視圖中介者
- 遊戲主要使用Command來控制遊戲流程

#### 關鍵目錄結構
```
assets/src/
├── sgv3/                    # 框架核心
│   ├── command/            # 通用指令
│   ├── proxy/              # 數據代理
│   └── vo/                 # 值對象
├── game/                   # 遊戲特定實作
│   ├── command/            # 遊戲指令
│   └── proxy/              # 遊戲代理
```

### 2.2 Big Win門檻定義位置
**檔案位置**：`assets/src/sgv3/command/byGame/MultipleCalculateCommand.ts`

```typescript
// 一般渠道的門檻定義
const winTypeRangesNormal = [
    { min: 15, max: 35, type: WinType.bigWin, duration: BaseScoringDuration.Scoring_Win01 },
    { min: 35, max: 100, type: WinType.megaWin, duration: BaseScoringDuration.Scoring_Win02 },
    { min: 100, max: Number.MAX_VALUE, type: WinType.epicWin, duration: BaseScoringDuration.Scoring_Win03 }
];

// 全渠道的門檻定義（較高）
const winTypeRangesOmni = [
    { min: 17, max: 35, type: WinType.bigWin, duration: BaseScoringDuration.Scoring_Win01 },
    // ...
];
```

**重點**：專案主要使用一般渠道的15倍作為Big Win門檻

## 3. 實作方法

### 3.1 定位結算控制指令

#### Free Game結算指令
**檔案位置**：`assets/src/game/command/state/GAME_Game2EndCommand.ts`
**核心方法**：`showCreditBoard()` - 控制結算面板顯示

#### Dragon Bonus結算指令
**檔案位置**：`assets/src/game/command/dragon-up/GAME_4_CreditCollectResultCommand.ts`
**核心方法**：`showCreditBoard()` - 控制結算面板顯示

### 3.2 實作跳過邏輯

在兩個結算指令中都添加相同的判斷邏輯：

```typescript
protected showCreditBoard() {
    // ... 原有邏輯 ...
    
    let totalWin: number = this.gameDataProxy.convertCredit2Cash(
        this.gameDataProxy.spinEventData.playerTotalWin  // 或對應的贏分來源
    );

    // 檢查是否達到Big Win標準，未達到則跳過結算面板
    if (!this.isBigWinOrAbove(totalWin)) {
        // 贏分小於Big Win，直接跳過結算面板回到BaseGame
        this.delayCloseBoard();
        return;
    }

    // 達到Big Win以上，正常顯示結算面板
    this.sendNotification(StateWinEvent.SHOW_LAST_CREDIT_BOARD, totalWin);
    // ... 後續邏輯 ...
}

/**
 * 判定贏分是否達到Big Win標準
 * @param totalWin 總贏分金額
 * @returns true: 達到Big Win以上, false: 未達到Big Win
 */
private isBigWinOrAbove(totalWin: number): boolean {
    const curTotalBet = this.gameDataProxy.curTotalBet;
    const winMultiple = MathUtil.div(totalWin, curTotalBet);
    
    // Big Win門檻：使用臨時設定或預設15倍
    const bigWinThreshold = this.gameDataProxy.tempBigWinThreshold;
    
    return winMultiple >= bigWinThreshold;
}
```

### 3.3 添加測試功能

#### 數據層添加測試屬性
**檔案位置**：`assets/src/sgv3/vo/config/GameData.ts`
```typescript
/** 臨時Big Win門檻測試 */
public tempBigWinThreshold: number = 15;
```

#### 代理層添加存取方法
**檔案位置**：`assets/src/sgv3/proxy/GameDataProxy.ts`
```typescript
/** 臨時Big Win門檻測試 */
public get tempBigWinThreshold(): number {
    return this._gameData.tempBigWinThreshold;
}
public set tempBigWinThreshold(_val: number) {
    this._gameData.tempBigWinThreshold = _val;
}
```

#### Web橋接層添加Console指令
**檔案位置**：`assets/src/sgv3/proxy/WebBridgeProxy.ts`

在 `initAPI()` 方法中註冊指令：
```typescript
// Console指令
window['setBigWinThreshold'] = (_threshold: number) => this.setBigWinThreshold(_threshold);
```

實作指令方法：
```typescript
/**
 * 設定Big Win門檻測試
 * 使用方式：setBigWinThreshold(20) - 設定為20倍
 */
public setBigWinThreshold(threshold: number): void {
    if (threshold && threshold > 0) {
        this.gameDataProxy.tempBigWinThreshold = threshold;
        console.log(`🎯 Big Win門檻已設定為 ${threshold}x`);
        console.log('💡 提示：此設定會在下次feature game結算時生效');
    } else {
        console.log('❌ 請輸入大於0的數值');
    }
}
```

## 4. 關鍵技術點說明

### 4.1 PureMVC Command模式
- Command負責處理具體的業務邏輯
- 透過 `sendNotification()` 發送事件通知
- 透過 `facade.retrieveProxy()` 獲取數據代理

### 4.2 數學計算
使用 `MathUtil.div()` 進行浮點數除法，避免JavaScript浮點數精度問題

### 4.3 狀態流轉
- `delayCloseBoard()` 方法負責清理並轉換到下一個遊戲狀態
- 使用 `GlobalTimer` 進行時間控制

### 4.4 通知機制
- `StateWinEvent.SHOW_LAST_CREDIT_BOARD` 用於顯示結算面板
- `WinEvent.FORCE_WIN_DISPOSE` 用於強制清理贏分顯示
- `CheckGameFlowCommand.NAME` 用於檢查遊戲流程

## 5. 測試驗證

### 5.1 測試方法
1. 開啟遊戲後在Console執行：`setBigWinThreshold(20)`
2. 觸發Free Game或Dragon Bonus
3. 觀察結算時的行為

### 5.2 預期結果
- 當實際倍數(15.4x) < 設定門檻(20x)時：跳過結算面板
- 當實際倍數 >= 設定門檻時：正常顯示結算面板
- Big Win動畫不受影響（由其他邏輯控制）

## 6. 學習重點總結

### 6.1 專案架構理解
- 掌握PureMVC的MVC三層架構
- 理解Command-Proxy-Mediator的職責分工
- 了解遊戲狀態機的運作方式

### 6.2 程式設計模式
- 策略模式：條件性執行不同邏輯
- 代理模式：透過Proxy管理數據訪問
- 觀察者模式：透過通知機制解耦組件

### 6.3 遊戲開發實務
- 了解遊戲結算流程的設計
- 學習如何添加測試功能而不影響正式邏輯
- 掌握Console指令的實作方式

### 6.4 TypeScript開發技巧
- 介面設計與實作
- 類型安全的數據訪問
- 模組化程式組織

## 7. 可能的延伸思考

1. **效能考量**：是否需要快取門檻值避免重複計算？
2. **擴展性**：如何支援不同遊戲模式的不同門檻？
3. **測試完整性**：如何編寫自動化測試驗證此功能？
4. **用戶體驗**：跳過結算面板是否需要其他視覺回饋？

這些思考點可以幫助更深入理解遊戲系統設計的複雜性和考量因素。