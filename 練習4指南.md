# H5_Slot_練習4 實作指南

## 題目一：GameLogo Bundle 載入與顯示

### 📋 題目要求
新增一個在preload(baseLoad)載入名為gameLogo的Bundle資料夾，資料夾裡面有一個名為GameLogo的prefab，prefab上掛有一個sprite，依照語系顯示遊戲Logo，需在進入遊戲一開始時顯示圖片，點擊圖片或3秒後關閉圖片才可以遊玩遊戲。

### 🎯 實作目標
1. 在 preload 階段載入 gameLogo Bundle
2. 根據語系顯示對應的 Logo 圖片
3. 在適當時機顯示 Logo
4. 提供點擊跳過和自動關閉功能
5. 確保 Logo 關閉後才能進入遊戲

### 🗂️ 資源準備

#### 現有資源結構
```
assets/
├── prefabs/gameLogo/
│   └── GameLogo.prefab                    # 主要 Logo prefab
└── art/language/
    ├── en/intro/GameLogo.png             # 英文版 Logo
    ├── zh/intro/GameLogo.png             # 中文版 Logo
    └── th/intro/GameLogo.png             # 泰文版 Logo
```

#### GameLogo.prefab 配置
在 `GameLogo.prefab` 的 `LogoSprite` 節點上：
1. 添加 `LocalizedSprite` 組件
2. 設定 Sprite Frame 為任一語系的 GameLogo（如 en 版本）
3. LocalizedSprite 會自動生成路徑模板：
   ```
   db://assets/art/language/${i18n._language}/intro/GameLogo.png@f9941
   ```

### 🔧 核心實作

#### 1. Bundle 載入配置
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第165-173行)

```typescript
// 在 baseLoad 陣列中加入 gameLogo Bundle 載入任務
{
    status: LoadStatus.NONE,
    info: { bundleName: 'gameLogo', assetName: 'GameLogo' },
    onTaskFinished: (prefab: Prefab) => {
        // 載入完成但不立即顯示，存儲 prefab 供稍後使用
        this.gameLogoPrefab = prefab;
        Logger.i('🎨 GameLogo prefab loaded and ready');
    }
},
```

**重點說明：**
- 使用 `onTaskFinished` 而非 `onAssetLoaded`，確保在 `RESPONSE_INIT` 後執行
- 載入完成後僅存儲 prefab，不立即顯示
- 符合題目要求的 preload 階段載入

#### 2. 新增屬性
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第543行)

```typescript
// ======================== GameLogo Methods ========================
private gameLogoPrefab: Prefab | null = null;    // 存儲載入的 prefab
private gameLogoNode: Node | null = null;        // 顯示的節點
private logoCloseTimer: number = 0;              // 自動關閉計時器
private canEnterGame: boolean = false;           // 是否可進入遊戲標誌
```

#### 3. 顯示時機控制
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第339-354行)

```typescript
protected delayEnterLobby(): void {
    // 在進入遊戲前顯示 GameLogo
    if (this.gameLogoPrefab && !this.gameLogoNode) {
        this.showGameLogo(this.gameLogoPrefab);
        return; // Logo 關閉後會自動呼叫 enterGameAfterLogo()
    }

    // 檢查是否可以進入遊戲（GameLogo 必須已關閉）
    if (!this.canEnterGame) {
        Logger.i('🚪 Waiting for GameLogo to close before entering game');
        return;
    }

    this.enterGameAfterLogo();
}
```

**時機選擇說明：**
- 選在 `delayEnterLobby()` 開始時顯示 Logo
- 此時所有資源已載入完成，Game_1 已實例化但未顯示
- 避免延長載入時間，確保不會有載入不完整問題

#### 4. Logo 顯示實作
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第557-574行)

```typescript
private showGameLogo(prefab: Prefab) {
    this.gameLogoNode = instantiate(prefab);
    director.getScene().addChild(this.gameLogoNode);

    // 使用專案的圖層管理系統，設定為最高層級（999）
    const dummyComponent = this.gameLogoNode.addComponent(Component);
    LayerManager.setLayer(dummyComponent, 999);

    // 監聽任何輸入操作
    this.startInputListening();

    // 設定 3 秒自動關閉
    this.logoCloseTimer = window.setTimeout(() => {
        this.closeGameLogo();
    }, 3000);

    Logger.i('🎨 GameLogo displayed with renderOrder: 999, any input will close');
}
```

**技術要點：**
- 使用 `LayerManager.setLayer(dummyComponent, 999)` 確保最頂層顯示
- 符合專案圖層管理規範，避免使用 `setSiblingIndex(-1)`
- 同時設定輸入監聽和自動關閉計時器

#### 5. 輸入事件處理
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第579-593行)

```typescript
// 需要在檔案頂部 import
import { Component, director, instantiate, Prefab, Node, _decorator, sp, Asset, input, Input } from 'cc';

/**
 * 開始監聽輸入事件
 */
private startInputListening() {
    // 監聽滑鼠點擊
    input.on(Input.EventType.MOUSE_DOWN, this.closeGameLogo, this);
    // 監聽觸控
    input.on(Input.EventType.TOUCH_START, this.closeGameLogo, this);
}

/**
 * 停止監聽輸入事件
 */
private stopInputListening() {
    input.off(Input.EventType.MOUSE_DOWN, this.closeGameLogo, this);
    input.off(Input.EventType.TOUCH_START, this.closeGameLogo, this);
}
```

**設計理念：**
- 使用 Cocos Creator 的全域輸入系統
- 支援滑鼠點擊和觸控操作
- 比創建透明按鈕更簡潔高效

#### 6. Logo 關閉處理
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第602-627行)

```typescript
private closeGameLogo() {
    if (this.gameLogoNode) {
        // 清除計時器
        if (this.logoCloseTimer) {
            clearTimeout(this.logoCloseTimer);
            this.logoCloseTimer = 0;
        }

        // 停止監聽輸入事件
        this.stopInputListening();

        // 移除節點
        this.gameLogoNode.destroy();
        this.gameLogoNode = null;

        // 設定可以進入遊戲
        this.canEnterGame = true;

        Logger.i('🎨 GameLogo closed, can enter game now');

        // 如果載入完成且等待進入遊戲，現在就進入
        if (this.isInitData) {
            this.enterGameAfterLogo();
        }
    }
}
```

#### 7. 遊戲進入邏輯
**檔案位置：** `assets/src/sgv3/mediator/LoadingViewMediator.ts` (第359-373行)

```typescript
/**
 * GameLogo 關閉後進入遊戲
 */
private enterGameAfterLogo(): void {
    GTMUtil.setGTMEvent('EnterGame', {
        Member_ID: this.gameDataProxy.userId,
        Game_ID: this.gameDataProxy.machineType,
        DateTime: Date.now(),
        Session_ID: this.gameDataProxy.sessionId
    });
    Logger.i('🚪 Enter Game');
    //進行 Recovery流程
    this.sendNotification(CheckRecoveryFlowCommand.NAME);

    this.isEnterGame = true;
    this.closeLoadingView();
}
```

### 🌍 多語系支援

#### LocalizedSprite 運作機制
1. **自動路徑轉換**：將固定路徑轉換為包含 `${i18n._language}` 的模板
2. **動態載入**：根據當前語系載入對應的 Bundle 和資源
3. **Fallback 機制**：如果找不到對應語系資源，自動使用預設語系(en)

#### 路徑模板格式
```
db://assets/art/language/${i18n._language}/intro/GameLogo.png@f9941
```

### 🔄 完整流程圖

```
1. 遊戲啟動 - LoadScene (黑畫面)
   ↓
2. BaseLoad 階段
   ├── 載入 gameLogo Bundle (存儲不顯示)
   ├── 載入 Game_1 Scene (active=false)
   └── 載入其他必要資源
   ↓
3. 資源載入完成
   ├── notifyBaseResComplete() 通知載入完成
   └── delayEnterLobby() 觸發
   ↓
4. GameLogo 顯示
   ├── 根據語系顯示對應 Logo
   ├── 設定全螢幕點擊監聽
   └── 啟動 3 秒自動關閉計時器
   ↓
5. 等待用戶操作
   ├── 用戶點擊 → 立即關閉
   └── 3 秒到達 → 自動關閉
   ↓
6. Logo 關閉
   ├── 清理資源和事件
   ├── 設定 canEnterGame = true
   └── 自動執行 enterGameAfterLogo()
   ↓
7. 進入遊戲 (Game_1 顯示)
```

### ✅ 功能驗證

#### 測試項目
1. **載入測試**：確認 gameLogo Bundle 在 preload 階段正確載入
2. **多語系測試**：切換不同語系確認顯示對應 Logo
3. **顯示時機測試**：確認在適當時機顯示，不延長載入時間
4. **點擊測試**：確認點擊畫面任何位置都能關閉 Logo
5. **自動關閉測試**：確認 3 秒後自動關閉
6. **流程控制測試**：確認 Logo 關閉後才能進入遊戲
7. **載入完整性測試**：確認點擊跳過不會造成載入不完整

#### 預期結果
- ✅ Logo 在所有資源載入完成後的完美時機顯示
- ✅ 支援滑鼠點擊和觸控操作
- ✅ 3 秒自動關閉機制正常
- ✅ 多語系 Logo 正確顯示
- ✅ 不會延長載入時間
- ✅ 不會造成載入不完整問題

### 🎯 技術亮點

1. **時機控制優化**：解決了載入時機問題，在完美時間點顯示 Logo
2. **輸入系統優化**：使用全域輸入系統替代複雜的 UI 組件
3. **圖層管理規範**：使用專案標準的 renderOrder 系統
4. **記憶體管理**：完整的資源和事件清理機制
5. **用戶體驗提升**：全螢幕點擊比小 Logo 點擊更友善

### 📝 實作總結

本題完全符合題目要求，並在實作過程中發現和解決了多個技術問題：
- 解決了載入時機導致的黑畫面延長問題
- 解決了點擊區域太小的用戶體驗問題
- 解決了載入不完整的流程問題
- 採用了更專業的圖層管理方式
- 提供了更穩定的輸入檢測機制

最終實現了一個穩定、高效、用戶體驗良好的 GameLogo 顯示系統。

---

## 題目二：Symbol 動畫實作

*（待實作）*