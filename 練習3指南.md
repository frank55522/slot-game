# 練習3 實作指南

## 題目描述

### 題目1：在播放滾分音效時淡出或暫停播放BGM，直到滾分結束
### 題目2：製作一個物件，並使用LocalizedLabel讓物件在畫面上根據不同語系表現出不同的結果
### 題目3：把M字獎的symbol連線表演改成播放動畫(可參考wild)，動畫自訂

---

## 題目1 實作指南：滾分時BGM淡出功能

### 1. 實作前的思路構築

#### 1.1 問題分析
- **核心需求**：在滾分音效播放期間，將背景音樂淡出，避免音效互相干擾
- **觸發條件**：滾分音效開始播放時
- **結束條件**：滾分表演完成時
- **影響範圍**：主遊戲(Game_1)滾分、免費遊戲(Game_2)滾分、特色遊戲結束後總贏分滾分

#### 1.2 技術思考點
1. 需要理解不同遊戲場景的BGM種類
2. 找到滾分音效播放的入口點和結束點
3. 利用AudioManager現有的淡入淡出功能
4. 確保不影響原有的滾分音效邏輯
5. **重要發現**：Game_4(昇龍賞)本身沒有滾分，滾分只在離開後回到Game_1時發生

### 2. 專案架構理解

#### 2.1 滾分系統分析

**滾分處理核心文件**：`assets/src/sgv3/command/byGame/ScoringHandleCommand.ts`

#### 滾分流程時序
```
handleScoring() -> playScoring() -> 滾分表演 -> runComplete() -> playScoringEnd()
     ↓              ↓                ↓              ↓              ↓
   設置數據        播放音效        進行滾分        表演結束        停止音效
```

#### 2.2 BGM系統分析

**不同場景的BGM類型**：
- **Game_1 (主遊戲)**：`BGM_Base` - 主遊戲背景音樂
- **Game_2 (免費遊戲)**：`BGM_FreeGame` - 免費旋轉背景音樂
- **Game_4 (昇龍賞)**：`BGM_DragonUp` - 但Game_4中不會觸發滾分！

**AudioManager的淡入淡出功能**：
```typescript
// 淡出到0音量，耗時0.5秒
AudioManager.Instance.fade(BGMClipsEnum.BGM_Base, 0, 0.5);

// 淡入到1音量，耗時1.0秒
AudioManager.Instance.fade(BGMClipsEnum.BGM_Base, 1, 1.0);
```

### 3. 詳細實作步驟

#### 步驟1：添加BGM枚舉導入

**檔案位置**：`assets/src/sgv3/command/byGame/ScoringHandleCommand.ts`

**修改內容**：
```typescript
// 修改前
import { ScoringClipsEnum } from '../../../game/vo/enum/SoundMap';

// 修改後
import { ScoringClipsEnum, BGMClipsEnum } from '../../../game/vo/enum/SoundMap';
```

#### 步驟2：在滾分開始前添加BGM淡出

**修改位置**：`ScoringHandleCommand.ts` 第78-91行

**修改內容**：
```typescript
GlobalTimer.getInstance()
    .registerTimer(
        this.timerKey_Sound,
        delayTime,
        () => {
            // 滾分開始前淡出BGM
            this.fadeBGMForScoring(0, 0.5);
            this.playScoring(this.finalWinType);
            this.playScoringVocal(this.finalWinType);
            this.setScoringData(startAmount, targetAmount, winBoardTargetAmount);
        },
        this
    )
    .start();
```

**關鍵改動**：在第84行添加 `this.fadeBGMForScoring(0, 0.5);`

#### 步驟3：在滾分結束後添加BGM恢復

**修改位置**：`ScoringHandleCommand.ts` 第123-132行

**修改內容**：
```typescript
// 表演結束
protected runComplete(isForceComplete: boolean) {
    this.playScoringEnd(isForceComplete);
    // 滾分結束後恢復BGM
    this.fadeBGMForScoring(1, 1.0);
    this.sendNotification(WinEvent.RUN_WIN_LABEL_COMPLETE, {
        targetAmount: this.finalWinAmount,
        winBoardTargetAmount: this.finalWinBoardAmount,
        winType: this.finalWinType
    });
}
```

**關鍵改動**：在第126行添加 `this.fadeBGMForScoring(1, 1.0);`

#### 步驟4：實作BGM控制方法

**添加位置**：`ScoringHandleCommand.ts` 第266-283行

**新增方法**：
```typescript
/**
 * 根據遊戲場景淡入淡出BGM
 * @param volume 目標音量 (0-1)
 * @param duration 淡入淡出時間
 */
private fadeBGMForScoring(volume: number, duration: number) {
    switch (this.gameDataProxy.curScene) {
        case GameScene.Game_1:
            AudioManager.Instance.fade(BGMClipsEnum.BGM_Base, volume, duration);
            break;
        case GameScene.Game_2:
            AudioManager.Instance.fade(BGMClipsEnum.BGM_FreeGame, volume, duration);
            break;
        // Game_4 (昇龍賞) 中不會觸發滾分，滾分只在回到 Game_1 時發生
        // 所以不需要處理 Game_4 的 BGM
    }
}
```

### 4. 實作邏輯說明

#### 4.1 滾分觸發場景分析
1. **Game_1（主遊戲）**：普通中獎滾分 - 控制 `BGM_Base`
2. **Game_2（免費遊戲）**：免費旋轉中獎滾分 - 控制 `BGM_FreeGame`
3. **afterFeatureGame = true**：特色遊戲結束後回到 Game_1 的總贏分滾分 - 控制 `BGM_Base`

#### 4.2 Game_4特殊性
- **Game_4本身沒有滾分**：只有龍珠收集和數值顯示
- **滾分發生在離開後**：回到Game_1時才會進行總贏分滾分
- **不需要處理BGM_DragonUp**：因為滾分時已經回到Game_1，使用的是BGM_Base

#### 4.3 音效控制時序
```
滾分開始
    ↓
BGM淡出 (0.5秒內音量從1→0)
    ↓
播放滾分音效
    ↓
進行滾分表演
    ↓
滾分結束
    ↓
BGM淡入 (1.0秒內音量從0→1)
```

### 5. 實作完成效果

- **滾分開始時**：BGM在0.5秒內平滑淡出到靜音
- **滾分進行中**：只有滾分音效，沒有BGM干擾
- **滾分結束時**：BGM在1秒內平滑淡入恢復
- **無副作用**：不影響原有的滾分音效和表演邏輯
- **場景適應**：自動根據當前遊戲場景控制對應的BGM

### 6. 檔案修改總結

**修改檔案**：`E:\Github\slot-game\assets\src\sgv3\command\byGame\ScoringHandleCommand.ts`

**修改行數**：
- 第2行：添加BGMClipsEnum導入
- 第84行：添加滾分開始前BGM淡出
- 第126行：添加滾分結束後BGM恢復  
- 第271-283行：新增fadeBGMForScoring方法

**代碼行數增加**：約15行

---

## 題目2 實作指南：LocalizedLabel多語系顯示

*（待實作）*

---

## 題目3 實作指南：M符號連線動畫表演

*（待實作）*