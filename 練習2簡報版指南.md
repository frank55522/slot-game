# 練習2 簡報版實作指南

---

## 題目一：條件性跳過結算面板

◆ **行為**：當 Feature Game 結束時，總贏分低於 Big Win 門檻則跳過結算面板，直接返回 BaseGame

◆ **做法**：
- 利用現有的 `totalWinType` 判斷系統，避免硬編碼門檻值
- 在兩個結算指令中添加相同的條件判斷邏輯：
  - `GAME_Game2EndCommand.ts:36-40` (Free Game 結算)
  - `GAME_4_CreditCollectResultCommand.ts:105-110` (Dragon Bonus 結算)

◆ **關鍵程式碼**：
```typescript
// 檢查是否達到Big Win標準，未達到則跳過結算面板
if (!this.isBigWinOrAbove(totalWin)) {
    this.delayCloseBoard();  // 直接跳過結算面板
    return;
}

private isBigWinOrAbove(totalWin: number): boolean {
    const winType = this.gameDataProxy.totalWinType;
    return winType === WinType.bigWin || 
           winType === WinType.megaWin || 
           winType === WinType.superWin || 
           winType === WinType.jumboWin;
}
```

**位置**：
- `assets/src/game/command/state/GAME_Game2EndCommand.ts:36-40`
- `assets/src/game/command/dragon-up/GAME_4_CreditCollectResultCommand.ts:105-110`

---

## 題目二：分數球表演插入機制

◆ **需求**：BaseGame 滾停後若觸發特色遊戲(≥6顆球)，在收集前先表演

◆ **實作方法**：
- **攔截收集流程**：在 `GAME_Game1FeatureSelectionCommand.ts:15-29` 的 `execute()` 中加入球數檢查，≥6顆時不立即發送 `PREPARE_COLLECT_BALL` 事件
- **新增表演狀態**：在 `assets/src/sgv3/vo/enum/Reel.ts:34` 中添加 `BEFORE_COLLECT = 15`，並在 `assets/src/game/view/symbol/SymbolFXStateRegister.ts:30,232-280` 創建 `SymbolFXBeforeCollectState` 類別
- **實作表演邏輯**：在新類別的 `onPlay()` 方法中用 `tween()` API 做 1.2 秒的雙重縮放動畫（1.2倍→原大小→1.2倍→原大小）
- **事件監聽與處理**：在 `ReelViewMediator.ts:87,168-170` 中監聽 `BEFORE_COLLECT_BALL` 事件，收到後遍歷盤面找出分數球位置，從對象池取出 SymbolFX 並播放表演動畫
- **事件與延遲**：在 `assets/src/sgv3/util/Constant.ts:177` 定義 `BEFORE_COLLECT_BALL` 事件，先觸發表演，用 `setTimeout(1200ms)` 延遲發送原本的收集事件

◆ **技術實作架構**：

**1. 條件判斷層** (`GAME_Game1FeatureSelectionCommand.ts:15-29`)
```typescript
// 球數檢測與流程分支
if (ballCount >= 6) {
    // 觸發表演事件 → 延遲正常流程
    this.sendNotification(ViewMediatorEvent.BEFORE_COLLECT_BALL);
    setTimeout(() => {
        this.sendNotification(ViewMediatorEvent.PREPARE_COLLECT_BALL);
        this.endGame1FeatureSelection();
    }, 1200);
}
```

**2. 表演定義層** (`Reel.ts` + `SymbolFXStateRegister.ts`)
```typescript
// 新增表演類型與動畫邏輯
BEFORE_COLLECT = 15  // 新的表演ID

// 雙重縮放強調效果
tween(node)
    .to(0.3, { scale: targetScale })
    .to(0.3, { scale: originalScale })
    .to(0.3, { scale: targetScale })  
    .to(0.3, { scale: originalScale })
    .start();
```

**3. 事件處理層** (`ReelViewMediator.ts`)
```typescript
// 添加事件監聽 (第87行)
public listNotificationInterests(): Array<string> {
    return [
        ViewMediatorEvent.BEFORE_COLLECT_BALL  // 新增監聽
    ];
}

// 事件處理 (第168-170行)
case ViewMediatorEvent.BEFORE_COLLECT_BALL:
    this.playBeforeCollectBallAnimation();
    break;

// 表演邏輯 (第707-727行)
protected playBeforeCollectBallAnimation() {
    // 遍歷盤面找分數球
    for (let x = 0; x < ballHitInfo.ballScreenLabel.length; x++) {
        for (let y = 0; y < ballHitInfo.ballScreenLabel[x].length; y++) {
            if (ballHitInfo.ballScreenLabel[x][y] > 0) {
                // 從對象池取出SymbolFX並播放BEFORE_COLLECT動畫
                this.reelView.showBeforeCollectBallAnimation(symbolInfo, featureInfo);
            }
        }
    }
}
```

---

## 題目三：Timeline 動畫整合測試

◆ **目標**：建立包含 Spine + 序列圖動畫的測試環境，驗證動畫播放效果

◆ **技術路線**：
- **資源整合**：選用專案現有的 BigWin Spine 動畫和金龍序列圖資源
- **Prefab 架構設計**：建立階層式節點結構，根節點掛載 TimelineTool 組件統一管理
- **Timeline 數據配置**：設計多組播放方案（順序/同時/單獨），測試不同組合效果
- **測試環境驗證**：利用 TimelineToolScene 的可視化界面驗證配置正確性

◆ **實作細節**：

**1. 動畫資源選擇與配置**
- **Spine 動畫**：`BigWinShow.skel` 包含多種中獎特效（BigWin/MegaWin/SuperWin/JumboWin）
- **序列圖動畫**：`GoldDragon_00~28.png` 29幀金龍飛舞，通過 Animation 組件製作

**2. Timeline 數據結構設計**
```typescript
// 多場景測試配置
Array Timeline Data[0]: "SequentialPlay" - 先 Spine 後序列圖
Array Timeline Data[1]: "SimultaneousPlay" - 同時播放雙動畫
Array Timeline Data[2]: "TestSpine" - 單獨測試 Spine 效果
Array Timeline Data[3]: "TestSequence" - 單獨測試序列圖效果
```

**3. 節點架構與組件配置**
```
TimelineTestPrefab
├── TimelineTool (Array Timeline Data 配置中樞)
├── BigWinNode + sp.Skeleton (Spine 骨骼動畫)
└── GoldDragonNode + Animation + Sprite (序列圖動畫)
```

**4. 測試流程與效果驗證**
- 在 `TimelineToolScene` 中實例化 Prefab 進行可視化測試
- 通過 UI 下拉選單切換不同的 Timeline 配置
- 驗證動畫時序控制、資源載入、效果表現是否符合預期

**成果位置**：`assets/prefabs/TimelineTestPrefab.prefab`

---

## 總結

**三題技術要點**：
- **題目一**：善用現有 WinType 系統，避免硬編碼，確保邏輯一致性
- **題目二**：利用事件驅動架構，通過延遲機制卡住流程，使用對象池管理特效
- **題目三**：熟悉 Cocos Creator 動畫系統，掌握 Spine 和 Animation 的整合使用

**設計思維**：
- 非侵入性修改：在不破壞現有架構下添加新功能
- 模組化開發：組件職責分工明確，便於維護和擴展
- 工具化測試：使用專業工具進行動畫測試和驗證